{% extends 'app/base.html' %}
{% load static %}
{% block title %}Alice Chatbot{% endblock title %}

{% block main-content %}

<style>
/* Chat Container */
.chat-container {
    width: 480px;
    max-width: 95%;
    margin: 50px auto 80px; /* bottom margin for footer spacing */
    background: #fff0f6; /* light pinkish background */
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header */
.chat-header {
    background: linear-gradient(90deg, #ff6eb4, #ff85c1);
    color: #fff;
    padding: 18px;
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    letter-spacing: 1px;
}

/* Chat History */
.chat-history {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fff0f6; /* light pinkish */
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Messages */
.user-message, .bot-message {
    padding: 12px 20px;
    max-width: 75%;
    word-wrap: break-word;
    border-radius: 25px;
    font-size: 15px;
    line-height: 1.4;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.user-message {
    background: #ffe0f0;
    align-self: flex-start;
}

.bot-message {
    background: #ff6eb4;
    color: #fff;
    align-self: flex-end;
}

/* Input Area */
.chat-input-area {
    display: flex;
    padding: 15px;
    background: #fff;
    border-top: 1px solid #f0cce5;
}

#user-input {
    flex: 1;
    padding: 12px 20px;
    border-radius: 25px;
    border: 1px solid #ff85c1;
    font-size: 16px;
    outline: none;
    transition: 0.3s;
}

#user-input:focus {
    border-color: #ff6eb4;
    box-shadow: 0 0 5px rgba(255,110,180,0.3);
}

#send-button {
    background: linear-gradient(90deg, #ff6eb4, #ff85c1);
    color: #fff;
    border: none;
    padding: 12px 25px;
    margin-left: 10px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: 0.3s;
}

#send-button:hover {
    background: linear-gradient(90deg, #ff85c1, #ff6eb4);
    transform: translateY(-2px);
}

/* Scrollbar styling */
.chat-history::-webkit-scrollbar {
    width: 6px;
}

.chat-history::-webkit-scrollbar-thumb {
    background: rgba(255,110,180,0.4);
    border-radius: 3px;
}
</style>

<div class="chat-container">
    <div class="chat-header">
        Alice ðŸ¤–
    </div>

    <div id="chat-history" class="chat-history">
        <!-- Messages will appear here -->
    </div>

    <div class="chat-input-area">
        <input type="text" id="user-input" placeholder="Type your message..." autofocus>
        <button id="send-button"><i class="fas fa-paper-plane me-1"></i> Send</button>
    </div>
</div>

<script>
const chatHistory = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            if (cookie.trim().startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.trim().substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}

function appendMessage(className, message) {
    const msg = document.createElement('div');
    msg.className = className;
    msg.innerHTML = message;
    chatHistory.appendChild(msg);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function sendUserMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    appendMessage('user-message', message);

    const formData = new FormData();
    formData.append('user_message', message);

    fetch('/chatbot/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
    }).then(res => res.json())
      .then(data => appendMessage('bot-message', data.bot_response))
      .catch(err => console.error(err));

    userInput.value = '';
}

userInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendUserMessage(); });
sendButton.addEventListener('click', sendUserMessage);
</script>

{% endblock main-content %}
